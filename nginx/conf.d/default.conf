# Nature Marketplace - Nginx Configuration
# Works with Cloudflare proxy (SSL termination at Cloudflare)
# Protección contra scraping, bots y ataques

server {
    listen 80;
    server_name _;
    
    # Solo aceptar conexiones de Cloudflare (IPs de Cloudflare)
    # Descomentar en producción para ocultar IP real
    # set_real_ip_from 103.21.244.0/22;
    # set_real_ip_from 103.22.200.0/22;
    # set_real_ip_from 103.31.4.0/22;
    # set_real_ip_from 104.16.0.0/13;
    # set_real_ip_from 104.24.0.0/14;
    # set_real_ip_from 108.162.192.0/18;
    # set_real_ip_from 131.0.72.0/22;
    # set_real_ip_from 141.101.64.0/18;
    # set_real_ip_from 162.158.0.0/15;
    # set_real_ip_from 172.64.0.0/13;
    # set_real_ip_from 173.245.48.0/20;
    # set_real_ip_from 188.114.96.0/20;
    # set_real_ip_from 190.93.240.0/20;
    # set_real_ip_from 197.234.240.0/22;
    # set_real_ip_from 198.41.128.0/17;
    # real_ip_header CF-Connecting-IP;
    
    # Bloquear bots maliciosos inmediatamente
    if ($bad_bot) {
        return 403;
    }
    
    # Bloquear requests sospechosos (ataques comunes)
    if ($suspicious_request) {
        return 444;  # Cerrar conexión sin respuesta
    }
    
    # Certbot challenge
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Health check (sin rate limit)
    location /health {
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    # Robots.txt - controlar qué pueden indexar los bots
    location /robots.txt {
        return 200 "User-agent: *\nDisallow: /api/\nDisallow: /admin/\nDisallow: /minio-console/\nAllow: /\n";
        add_header Content-Type text/plain;
    }

    # Main site - rate limit general
    location / {
        limit_req zone=general burst=50 nodelay;
        
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
        proxy_set_header CF-IPCountry $http_cf_ipcountry;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
    }

    # Auth endpoints - rate limit estricto (anti brute force)
    location ~ ^/api/(auth|users/login|users/register)/ {
        limit_req zone=auth burst=3 nodelay;
        limit_req_status 429;
        
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 30;
    }

    # API endpoints - rate limit moderado
    location /api/ {
        limit_req zone=api burst=20 nodelay;
        limit_req_status 429;
        
        # Bloquear métodos no permitidos
        if ($request_method !~ ^(GET|POST|PUT|PATCH|DELETE|OPTIONS)$) {
            return 405;
        }
        
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
        proxy_set_header CF-IPCountry $http_cf_ipcountry;
        proxy_read_timeout 300;
        proxy_connect_timeout 300;
        
        # Limitar tamaño de body (prevenir ataques de payload grande)
        client_max_body_size 10M;
        
        # CORS headers
        add_header Access-Control-Allow-Origin $http_origin always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-CSRFToken" always;
        add_header Access-Control-Allow-Credentials "true" always;
        
        if ($request_method = OPTIONS) {
            return 204;
        }
    }

    # Django admin - rate limit + protección extra
    location /admin/ {
        limit_req zone=auth burst=5 nodelay;
        
        # Opcional: restringir a IPs específicas
        # allow YOUR_ADMIN_IP;
        # deny all;
        
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Static files - sin rate limit estricto, con cache
    location /static/ {
        limit_req zone=static burst=200 nodelay;
        alias /var/www/static/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        
        # Prevenir hotlinking (opcional)
        # valid_referers none blocked server_names *.yourdomain.com;
        # if ($invalid_referer) { return 403; }
    }

    # MinIO storage - rate limit para imágenes
    location /storage/ {
        limit_req zone=static burst=200 nodelay;
        
        rewrite ^/storage/(.*)$ /$1 break;
        proxy_pass http://minio;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        expires 7d;
        add_header Cache-Control "public";
    }

    # MinIO Console - solo admin
    location /minio-console/ {
        # IMPORTANTE: Restringir en producción
        # allow YOUR_ADMIN_IP;
        # deny all;
        
        limit_req zone=auth burst=5 nodelay;
        
        rewrite ^/minio-console/(.*)$ /$1 break;
        proxy_pass http://minio_console;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Bloquear archivos ocultos y sensibles
    location ~ /\. {
        deny all;
        return 444;
    }

    location ~* (\.env|\.git|\.svn|\.htaccess|\.htpasswd|\.DS_Store) {
        deny all;
        return 444;
    }
    
    # Bloquear extensiones de backup
    location ~* \.(bak|backup|old|orig|save|swp|tmp)$ {
        deny all;
        return 444;
    }
    
    # Bloquear acceso a archivos de configuración
    location ~* (composer\.json|package\.json|yarn\.lock|Gemfile|Makefile)$ {
        deny all;
        return 444;
    }
}
